<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>AI Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --success-color: #06d6a0;
            --warning-color: #ffd166;
            --danger-color: #ef476f;
            --dark-bg: #0f172a;
            --medium-bg: #1e293b;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --light-text: #f8fafc;
            --gray-text: #94a3b8;
            --border-radius: 1rem;
            --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            line-height: 1.5;
        }

        .chat-container {
            max-width: 900px;
            margin: 1.5rem auto;
            height: calc(100vh - 3rem);
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chat-header {
            padding: 1.25rem 1.75rem;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h1 {
            font-size: 1.75rem;
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header h1 i {
            font-size: 1.8rem;
        }

        .chat-header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
            background-color: var(--light-bg);
        }

        .message {
            max-width: 80%;
            padding: 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            animation: fadeIn 0.4s ease-out;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }

        .message:hover {
            transform: translateY(-2px);
        }

        .user-message {
            background-color: var(--primary-color);
            margin-left: auto;
            border-bottom-right-radius: 0;
            color: white;
        }

        .ai-message {
            background-color: white;
            margin-right: auto;
            border-bottom-left-radius: 0;
            color: var(--dark-text);
            border-left: 3px solid var(--primary-color);
        }

        .message-content {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .message-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.75rem;
            text-align: right;
            font-weight: 300;
        }
        
        .ai-message .message-time {
            color: var(--gray-text);
        }

        .chat-input-container {
            padding: 1.5rem;
            background-color: white;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chat-input-wrapper {
            display: flex;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 1.25rem;
            padding-right: 6rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background-color: white;
            color: var(--dark-text);
            font-size: 1rem;
            resize: none;
            min-height: 52px;
            max-height: 200px;
            transition: var(--transition);
            margin-right: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
        }

        .send-button, .upload-button {
            position: absolute;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0.5rem;
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .send-button {
            padding-left: 5px;
            right: 0.75rem;
            bottom: 0.75rem;
            border-radius: 0.5rem;
        }

        .send-button:hover {
            color: var(--secondary-color);
            transform: scale(1.15) rotate(15deg);
        }

        .upload-button {
            right: 3.25rem;
            bottom: 0.75rem;
        }

        .upload-button:hover {
            color: var(--secondary-color);
            transform: scale(1.15);
        }

        .typing-indicator {
            padding: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            width: fit-content;
            border-bottom-left-radius: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left: 3px solid var(--primary-color);
        }

        .typing-animation {
            display: flex;
            align-items: center;
        }

        .typing-dot {
            height: 0.5rem;
            width: 0.5rem;
            margin-right: 4px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: typingAnimation 1.5s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
            margin-right: 0;
        }

        @keyframes typingAnimation {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
            100% {
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive fixes */
        @media (max-width: 768px) {
            .chat-container {
                margin: 0;
                height: 100vh;
                border-radius: 0;
            }

            .message {
                max-width: 90%;
            }

            .chat-header-actions {
                gap: 6px;
            }

            .header-btn {
                padding: 0.5rem 0.9rem;
                font-size: 0.85rem;
            }
            
            .chat-header-actions .button-text {
                display: none;
            }
        }
        
        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 10px;
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: rgba(67, 97, 238, 0.3);
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: rgba(67, 97, 238, 0.5);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1><i class="fas fa-comments"></i>AI Chat</h1>
            <div class="chat-header-actions">
                <a href="/documents" class="header-btn">
                    <i class="fas fa-folder"></i>
                    <span class="button-text">Tài liệu</span>
                </a>
                <a href="/upload" class="header-btn">
                    <i class="fas fa-upload"></i>
                    <span class="button-text">Tải lên</span>
                </a>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="ai-message" data-aos="fade-up">
                <div class="message-content">
                    Xin chào! Tôi là trợ lý AI, sẵn sàng trả lời câu hỏi của bạn về các tài liệu. Bạn có thể hỏi tôi về nội dung trong tài liệu hoặc tải lên tài liệu mới.
                </div>
                <div class="message-time">Hôm nay, lúc <span th:text="${#dates.format(#dates.createNow(), 'HH:mm')}"></span></div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea id="questionInput" class="chat-input" placeholder="Nhập câu hỏi của bạn..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                <button id="uploadDocButton" class="upload-button" title="Tải lên tài liệu">
                    <i class="fas fa-file-upload"></i>
                </button>
                <button id="sendButton" class="send-button" onclick="sendQuestion()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo AOS animation
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true
            });
            
            // Auto-resize textarea
            const textarea = document.getElementById('questionInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(200, this.scrollHeight) + 'px';
            });
            
            // Upload document redirect
            document.getElementById('uploadDocButton').addEventListener('click', function() {
                window.location.href = '/upload';
            });
            
            // Focus on input when page loads
            textarea.focus();
        });
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendQuestion();
            }
        }

        async function sendQuestion() {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) return;
            
            // Add user message
            addMessage(question, true);
            
            // Clear input
            questionInput.value = '';
            questionInput.style.height = 'auto';
            
            // Add typing indicator
            const typingIndicator = addTypingIndicator();
            
            try {
                const response = await fetch('/chat/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                // Remove typing indicator
                typingIndicator.remove();
                
                // Add AI response
                addMessage(data.answer, false);
            } catch (error) {
                console.error('Error:', error);
                typingIndicator.remove();
                addMessage('Xin lỗi, có lỗi xảy ra. Vui lòng thử lại sau.', false);
            }
        }
        
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = isUser ? 'user-message' : 'ai-message';
            messageDiv.setAttribute('data-aos', 'fade-up');
            
            const currentTime = new Date();
            const timeString = currentTime.getHours().toString().padStart(2, '0') + ':' + 
                              currentTime.getMinutes().toString().padStart(2, '0');
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">Hôm nay, lúc ${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }
        
        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-animation">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return typingDiv;
        }
    </script>
</body>
</html>
