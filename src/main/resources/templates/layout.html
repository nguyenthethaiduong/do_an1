<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} ?: 'Document Management System'">Document Management System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link th:href="@{/css/style.css}" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Custom JavaScript -->
    <script th:src="@{/js/main.js}" defer></script>
    <style>
        /* Responsive navigation */
        @media (max-width: 768px) {
            .header .container {
                padding: 0 15px;
            }
            .navbar {
                flex-direction: column;
                align-items: flex-start;
            }
            .navbar-brand {
                margin-bottom: 10px;
            }
            .nav-links {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            .nav-links a {
                padding: 8px 0;
                border-bottom: 1px solid rgba(0,0,0,0.1);
                width: 100%;
            }
            .container {
                width: 100%;
                padding-left: 15px;
                padding-right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="navbar-brand">Document Management</a>
                <div class="nav-links">
                    <a href="/documents" th:class="${#httpServletRequest.requestURI == '/documents'} ? 'active'">Documents</a>
                    <a href="/upload" th:class="${#httpServletRequest.requestURI == '/upload'} ? 'active'">Upload</a>
                    <a href="/chat" th:class="${#httpServletRequest.requestURI == '/chat'} ? 'active'">Chat</a>
                    <a href="/analytics" th:class="${#httpServletRequest.requestURI == '/analytics'} ? 'active'">Analytics</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container py-4">
        <div th:if="${message}" class="alert" th:classappend="${messageType} ?: 'alert-info'" th:text="${message}"></div>
        <div th:replace="${content}"></div>
    </main>

    <!-- Footer -->
    <footer class="footer bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 Document Management System. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Thêm vào phần xử lý câu hỏi
        function analyzeIntent(question) {
            const possibleIntents = detectPossibleIntents(question);
            if (possibleIntents.length > 1) {
                return {
                    needsConfirmation: true,
                    message: "Bạn đang hỏi về " + possibleIntents.map(i => i.description).join(" hay ") + "?"
                };
            }
            return { needsConfirmation: false, intent: possibleIntents[0] };
        }
    </script>

    <script>
    let cooldownActive = false;
    let cooldownTimer = null;
    const cooldownSeconds = 5; // Thời gian chờ giữa các yêu cầu

    async function sendQuestion() {
        const question = questionInput.value.trim();
        if (!question || cooldownActive) return;

        // Kích hoạt cooldown
        activateCooldown();

        // Disable input và button
        questionInput.disabled = true;
        sendButton.disabled = true;

        // Add user message
        addMessage(question, true);

        // Clear input
        questionInput.value = '';
        questionInput.style.height = 'auto';

        // Add typing indicator
        const typingIndicator = addTypingIndicator();

        try {
            const response = await fetch('/chat/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question: question })
            });

            if (!response.ok) {
                if (response.status === 429) {
                    // Thông báo giới hạn tốc độ
                    typingIndicator.remove();
                    addMessage('Bạn đang gửi câu hỏi quá nhanh. Vui lòng đợi giây lát trước khi gửi câu hỏi tiếp theo.', false);
                    
                    // Tăng thời gian cooldown khi gặp lỗi 429
                    extendCooldown(15); // 15 giây
                } else {
                    throw new Error('Network response was not ok');
                }
                return;
            }

            const data = await response.json();

            // Remove typing indicator
            typingIndicator.remove();

            // Add AI response
            addMessage(data.answer);
        } catch (error) {
            console.error('Error:', error);
            typingIndicator.remove();
            addMessage('Xin lỗi, có lỗi xảy ra. Vui lòng thử lại sau.');
        } finally {
            // Re-enable input and button sau khi cooldown kết thúc
            setTimeout(() => {
                questionInput.disabled = false;
                sendButton.disabled = false;
                questionInput.focus();
            }, cooldownActive ? 0 : 500);
        }
    }

    function activateCooldown() {
        cooldownActive = true;
        sendButton.disabled = true;
        
        let seconds = cooldownSeconds;
        sendButton.innerHTML = `<i class="fas fa-clock"></i> ${seconds}`;
        
        cooldownTimer = setInterval(() => {
            seconds--;
            if (seconds <= 0) {
                clearInterval(cooldownTimer);
                cooldownActive = false;
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            } else {
                sendButton.innerHTML = `<i class="fas fa-clock"></i> ${seconds}`;
            }
        }, 1000);
    }

    function extendCooldown(seconds) {
        if (cooldownTimer) {
            clearInterval(cooldownTimer);
        }
        
        cooldownActive = true;
        sendButton.disabled = true;
        
        let remainingSeconds = seconds;
        sendButton.innerHTML = `<i class="fas fa-clock"></i> ${remainingSeconds}`;
        
        cooldownTimer = setInterval(() => {
            remainingSeconds--;
            if (remainingSeconds <= 0) {
                clearInterval(cooldownTimer);
                cooldownActive = false;
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            } else {
                sendButton.innerHTML = `<i class="fas fa-clock"></i> ${remainingSeconds}`;
            }
        }, 1000);
    }
    </script>
</body>
</html> 